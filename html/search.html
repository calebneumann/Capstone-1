<!DOCTYPE html>
<HTML>
    <HEAD>
        <META NAME="GENERATOR" Content="Microsoft Visual Studio">
        <TITLE>Product Search</TITLE>
        <link rel="stylesheet" type="text/css" href="search.css">
    </HEAD>
    <div class="container">
    <BODY>

        <div class="navbar">
                <div class="nav">
                    <a href="../index.html">
                        <img src="logo2.jpg" alt="Snow" style="width:100px" style="height:100px">
                    </a>
                    <div id="topLinks" class="anchor-container">
                        <h4>
                            <a href='../index.html'>Home</a>
                            <a href='search.html'>Search</a>
                            <a href='about_us.html'>About Us</a>
                            <a href='login.html'>Log in</a>
                            
    
                        </h4>
                    </div>
    
                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', async () => {
                        fetch('/logInCheck')
                            .then(async response => {
                                const result = await response.text();
                            if(result != ""){
                                var topBar = "<h4><a href='../index.html'>Home</a>";
                                    topBar += "<a href='search.html'>Search</a>";
                                    topBar += "<a href='about_us.html'>About Us</a>"
                                    topBar += "<a href='profile.html'>Profile</a></h4>"
    
                                document.getElementById('topLinks').innerHTML = topBar
                            }
                        
                        })
                        .catch(error => {
                            document.getElementById('errorMessage').innerHTML = 'Error';
                        })
    
                    });
                  </script>
            </div>
        </div>
        <div class="main">
        <br><br><br><br>
        <h1>Product Search</h1>
        <h3>
            <div class="container" id="prod1">Product info will be here</div>
        </h3>
        <br>
        <h3>
            <div class="container" id="prod2"></div>
        </h3>
        <br>
        <h3>
            <div class="container" id="prod3"></div>
        </h3>
        <script>
//<----------------------------------------delete below when done with testing-------------------------->
                var product11;
                var product22;
                var product33;

            document.addEventListener('DOMContentLoaded', async () => {
                fetch("example.json")
                .then((res) => {
                    if (!res.ok) {
                        throw new Error
                            (`HTTP error! Status: ${res.status}`);
                    }
                    console.log(res.json.body)
                    var searchData = res.json["shopping_results"];
                    console.log(searchData)
                    return res.json();
                })
                .then((data) => {
                    console.log(data)
                    var searchData = data["shopping_results"];
                    console.log(searchData);
                    product11 = document.getElementById('prod1');
                    product22 = document.getElementById('prod2');
                    product33 = document.getElementById('prod3');
        
                    //currently gets the top 3 results and displays info about them
        
                    //available parameters are: title, link (where the actual product is), product_link (from google.com/shopping), 
                    //source (where it's sold), price, condition (new, used, etc.), rating, reviews (# of reviews), 
                    //delivery (delivery options), extensions (color of product, material of product, etc.), thumbnail)
                    
                    product11.innerHTML = '<img class="image" src=' + '"' + searchData[0].thumbnail + '">' + '<h1>Result #1<ul><li><a href="' + searchData[0].link + '"> '+searchData[0].title+"</a></li><li>Price: "+searchData[0].price+"</li><li>Distributor: "+searchData[0].source+"</li><li>Rating: "+searchData[0].store_rating+"</li></ul></h1>";
                    product22.innerHTML = '<img class="image" src=' + '"' + searchData[1].thumbnail + '">' + '<h1>Result #2<ul><li><a href="' + searchData[1].link + '"> '+searchData[1].title+"</a></li><li>Price: "+searchData[1].price+"</li><li>Distributor: "+searchData[1].source+"</li><li>Rating: "+searchData[1].store_rating+"</li></ul></h1>";
                    product33.innerHTML = '<img class="image" src=' + '"' + searchData[2].thumbnail + '">' + '<h1>Result #3<ul><li><a href="' + searchData[2].link + '"> '+searchData[2].title+"</a></li><li>Price: "+searchData[2].price+"</li><li>Distributor: "+searchData[2].source+"</li><li>Rating: "+searchData[2].store_rating+"</li></ul></h1>";
        
                    product11 = "Name: " + searchData[0].title + ", Price: " + searchData[0].price + ", Distributor: " + searchData[0].source + ", Rating: " + searchData[0].store_rating + "\n";
                    product22 = "Name: " + searchData[1].title + ", Price: " + searchData[1].price + ", Distributor: " + searchData[1].source + ", Rating: " + searchData[1].store_rating + "\n";
                    product33 = "Name: " + searchData[2].title + ", Price: " + searchData[2].price + ", Distributor: " + searchData[2].source + ", Rating: " + searchData[2].store_rating + "\n";

                })
                .catch((error) =>
                    console.error("Unable to fetch data:", error));
                
            });


//<----------------------------------------delete above when done------------------------------------>
            var productData;
            //activates whenever the spacebar is used
            document.addEventListener("keydown", async (event) => {
                if(event.key == ' '){
                    const sttResponse = document.getElementById('sttResponse');
                    var response;
                    //alert("you entered space")
                    //activates recording until another spacebar press is detected, then the transcript is sent back
                    try {
                        response = await fetch('/stt', {
                            method: 'GET',
                            headers: {
                              'source-page': 'search'  // You can include the HTML page name here
                            }
                          }).then(res => res.text()).then(data => {
                            data = data.toLowerCase();
                            

                            if(data.includes("home page")){
                                window.location.href = "../index.html";
                            }
                            else if(data.includes("chat page")){
                                window.location.href = "/chatGPT.html";
                            }
                            else if(data.includes("about us")){
                                window.location.href = "/about_us.html";
                            }
                            else if(data.includes("login")){
                                window.location.href = "/login.html";
                            }
                            else if(data.includes("profile")){
                                window.location.href = "/profile.html";
                            }
                            else if(data.includes("register")){
                                window.location.href = "/register.html";
                            }
                            else if(data.includes("searching for")){
                                search_product(data);
                                document.getElementById('sttResponse').textContent = data; // Display the data
            
                            }
                            else if(data.includes("redirecting to")){
                                redirect(data);
                                document.getElementById('sttResponse').textContent = data; // Display the data
            
                            }
                            else{
                                document.getElementById('sttResponse').textContent = data; // Display the data
            
                            }
            
            
                        }); // Make a request to the server
                    } catch (error) {
                        console.error('Error fetching data:', error);
                    }
            
                }
                // do something
                //splits the response transcript into an array to extract the product name
                var product1;
                var product2;
                var product3;
                async function search_product(response){
                    let response_split = response.split(/\[(.*?)\]/);
                    let product_name = response_split[0]; //In the chatGPT prompt, I always have the response start with 'Searching for: [product]'
            
                    fetch('/searchProduct', {               //so the product will always be the 3rd element, or index 2
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: product_name })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        productData = data;
                        //sets which div the html will be sent to
                        product1 = document.getElementById('prod1');
                        product2 = document.getElementById('prod2');
                        product3 = document.getElementById('prod3');
            
                        //currently gets the top 3 results and displays info about them
            
                        //available parameters are: title, link (where the actual product is), product_link (from google.com/shopping), 
                        //source (where it's sold), price, condition (new, used, etc.), rating, reviews (# of reviews), 
                        //delivery (delivery options), extensions (color of product, material of product, etc.), thumbnail)
                        
                        product1.innerHTML = '<img class="image" src=' + '"' + data[0].thumbnail + '">' + '<h1>Result #1<ul><li><a href="' + data[0].link + '"> '+data[0].title+"</a></li><li>Price: "+data[0].price+"</li><li>Distributor: "+data[0].source+"</li><li>Rating: "+data[0].rating+"</li></ul></h1>";
                        product2.innerHTML = '<img class="image" src=' + '"' + data[1].thumbnail + '">' + '<h1>Result #2<ul><li><a href="' + data[1].link + '"> '+data[1].title+"</a></li><li>Price: "+data[1].price+"</li><li>Distributor: "+data[1].source+"</li><li>Rating: "+data[1].rating+"</li></ul></h1>";
                        product3.innerHTML = '<img class="image" src=' + '"' + data[2].thumbnail + '">' + '<h1>Result #3<ul><li><a href="' + data[2].link + '"> '+data[2].title+"</a></li><li>Price: "+data[2].price+"</li><li>Distributor: "+data[2].source+"</li><li>Rating: "+data[2].rating+"</li></ul></h1>";
            
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    
                        product1 = "Name: " + searchData[0].title + ", Price: " + searchData[0].price + ", Distributor: " + searchData[0].source + ", Rating: " + searchData[0].store_rating + "\n";
                        product2 = "Name: " + searchData[1].title + ", Price: " + searchData[1].price + ", Distributor: " + searchData[1].source + ", Rating: " + searchData[1].store_rating + "\n";
                        product3 = "Name: " + searchData[2].title + ", Price: " + searchData[2].price + ", Distributor: " + searchData[2].source + ", Rating: " + searchData[2].store_rating + "\n";


                }

                function redirect(itemNum){

                    const regex = /#(\d+)/;

                    // Extract the number and convert it to an integer
                    const match = itemNum.match(regex);
                    if (match && match[1]) {
                        const itemNumber = parseInt(match[1], 10);
                        // Display the extracted number
                        console.log("YOOO WE GOT ITEM #" + itemNumber)
                        console.log(productData[itemNumber-1])

                        const newTab = window.open(productData[itemNumber-1].link, '_blank');
                        // Remove focus from the new tab and bring it back to the original page
                        setTimeout(() => {
                            // If the tab was successfully created, blur it and focus back on the original tab
                            if (newTab) {
                                newTab.blur(); // Blur the new tab
                                window.focus(); // Focus back on the current window
                            }
                        }, 500);

                    } else {
                        console.log("Item number not found.");
                    }
                }


              });

              
        </script>
        <br><br><br>
        <div class="sticky-container">
        <h3>
            <div id="sttResponse">Press the Space Bar to record...</div>
        </h3>
    </div>
    </BODY>
</HTML>